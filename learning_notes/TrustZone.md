# ARM TrustZone技术简介

*针对消费电子设备安全的威胁解决方法有以下几种:*

*1)外部硬件安全模块*

	SIM卡具有特定的软硬件特性，保护卡内密钥等资源.但与设备接口通讯速度低,而且不能保护用户界面的安全

*2)内部的硬件安全模块*
	
	将类似的智能卡放到SoC里,Soc里有两个Core,一个普通的app Core和一个安全Core.但两个Core
	通信速度低,而且不能保护用户交互数据.

*3)软件虚拟化*

	虚拟化技术要保护用户界面的安全,需要在GPU控制中加入很多验证,GPU图形性能会有较大影响.

### TrustZone

*ARM针对消费电子设备安全提出的一种架构,其硬件架构是整个系统设计过程中安全体系的扩展.*

	将SoC硬件和软件资源分到两个世界(安全世界和普通世界).AMBA3 AXI总线系统能确保安全世界的
	资源不会被普通世界访问.两个世界也能分时的运行在同一个核上.

**处理器架构**

*每个物理处理器核提供两个虚拟核--非安全核(Non-secure, NS) & 安全核(Secure),两者的切换机制叫"monitor模式".*
	
	1) NS核只能访问NS系统资源，安全核可以访问所有资源.
	2) 普通世界可以通过SMC指令或硬件异常机制(IRQ、FIQ、data abort等)进入到monitor模式

*普通世界运行在NS core上,安全世界运行在Secure core上,通过Monitor进行切换.*

**普通世界的用户模式获取安全世界的服务**

*1)从普通世界的用户模式进入到普通世界的特权模式*

*2)调用SMC指令进入monitor模式,monitor模式备份普通世界上下文,然后进入到安全世界的特权模式*

*3)在安全世界执行环境中切换到安全世界的用户模式,执行相应的安全服务*

**Monitor模式**

*monitor模式中的代码备份和恢复两个虚拟核(NS core和S core)切换时的上下文*

*CP15的SCR register的NS位表明当前处理器所处的状态,SCR register在普通世界不能被访问.*

**L1内存**

*1)两个世界有自己对应的"L1内存"、MMU、本地的转换表(用于控制地址映射).Secure core可以访问所有内存.*

*2)TLB有个tag记录TLB表是哪个世界的; cache也有一位tag来记录该状态.*

**中断**

*普通世界中断源使用IRQ, 安全世界中断源使用FIQ.Linux中FIQ中断基本不使用,因此中断源都是IRQ.*

*1)CPU运行在普通世界时,其IRQ直接进入普通世界IRQ处理函数*

*2)CPU运行在安全世界时,其IRQ发生首先会进入到monitor模式,然后跳到普通世界的IRQ处理函数.这样会有中断延迟,对于非实时系统影响较小.*


# ARM Security Technology
## Building a Secure System using TrustZone Technology